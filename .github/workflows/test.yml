name: Tests

on:
    pull_request:
        branches: [ main ]
        paths:
            - 'src/**'
            - 'tests/**'
            - 'pyproject.toml'
            - '.github/workflows/test.yml'
    push:
        branches: [ main ]
        paths:
            - 'src/**'
            - 'tests/**'
            - 'pyproject.toml'
            - '.github/workflows/test.yml'
    workflow_dispatch:

jobs:
    test:
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest]
                python-version: ['3.12', '3.13', '3.14']
            fail-fast: false
        runs-on: ${{ matrix.os }}

        steps:
        - uses: actions/checkout@v5

        - name: Set up python version ${{ matrix.python-version }}
          uses: actions/setup-python@v6
          with:
            python-version: ${{ matrix.python-version }}

        - name: Install package
          run: |
            python -m pip install --upgrade pip
            python -m pip install .

        - name: Run tests
          run: python tests/run.py

    # Test `camptrack` "runs". Can detect import errors and more.
    cli-smoke-test:
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest]
                python-version: ['3.12', '3.13', '3.14']
            fail-fast: false
        runs-on: ${{ matrix.os }}

        steps:
        - uses: actions/checkout@v5

        - name: Set up python version ${{ matrix.python-version }}
          uses: actions/setup-python@v6
          with:
            python-version: ${{ matrix.python-version }}

        - name: Install package
          run: |
            python -m pip install --upgrade pip
            python -m pip install .

        - name: Test CLI startup
          run: |
            python -c "
            import sys
            import subprocess

            try:
                result = subprocess.run(
                    [sys.executable, '-m', 'camptrack', '--debug'],
                    timeout=30,
                    text=True,
                    capture_output=True,
                    input='\n\n\n'  # Some dummy input
                )

                if result.returncode == 1 and 'Login failed' in result.stdout:
                    print(f'CampTrack successfully started')
                    sys.exit(0)

                print(f'CampTrack exited with code: {result.returncode}')
                print(f'stdout: {result.stdout}')
                print(f'stderr: {result.stderr}')
                sys.exit(1)
            except subprocess.TimeoutExpired:
                print('CampTrack started successfully')
                sys.exit(0)
            except Exception as e:
                print(f'Failed starting CampTrack: {e}')
                sys.exit(1)
            "
